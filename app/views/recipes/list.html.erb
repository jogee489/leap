<script type="text/javascript">
  $(document).ready(function() {
  	// delete all of the recipes with the box checked
    $("#btnDelete").click(function() {
      var selected = [];
      // gather the id of all checked recipes
      $('.check-rec:checked').each(function() {
      	var id = $(this).closest('tr').find('#recipe_id').val();
        selected.push(id);
      });
      console.log(selected);
      $.ajax({
        url: "/recipes/destroy_multiple/",
       	method: "POST",
      	data: {recipe_ids: JSON.stringify(selected)},
        timeout: 5500,
        success: function() {
          console.log("success");
				},
      	error: function(jqXHR, textStatus, errorThrown) {
        	console.log("an error has occured");
        	console.log(textStatus);
        	console.log(errorThrown);
        }
			});
			location.reload();
    });

		// Logic for expanding recipe details when + or - is pressed.
		$(".expand").click(function() {
			$(this).closest("tr").next(".recipeDetails").toggle('slow');
			$(this).toggleClass("glyphicon-chevron-down");
			$(this).toggleClass("glyphicon-chevron-up");
		});
		
		
		// Toggle check boxes: check all checkboxes and enable delete button.
		$("#check-all").bind('change', function() {
			$('.check-rec').prop('checked', $("#check-all").is(':checked'));
			var numChecked = $('.check-rec:checked').size();
			if (numChecked == 0) {
				$('#btnDelete').addClass("disabled");
			} else if ($(this).prop("checked")) {
				$('#btnDelete').removeClass("disabled");
			}
		});
		
		// Individual checkbox click.
		$('.check-rec').bind('change', function() {
			var numChecked = $('.check-rec:checked').size();
			var maxChecked = $('.check-rec').size();
			 
			if ($('#btnDelete').hasClass("disabled") && numChecked > 0) {       
		  	$('#btnDelete').removeClass("disabled");
		  } else if (numChecked == 0) {
		  	$('#btnDelete').addClass("disabled");
		  } else if (numChecked < maxChecked) {
				$('#check-all').prop("checked", false);
			} else if (numChecked == maxChecked) {
				$('#check-all').prop("checked", true);
			}
		});

		$('.update-button').click(function() {
			var form = $(this).closest("form");
			var title = form.find("#title").val();
			var ingredients = form.find("#ingredients").val();
			var directions = form.find("#directions").val();
			var id = form.find("#recipe_id").val();
			var json = JSON.stringify({title: title, ingredients: ingredients, directions: directions});
			console.log(json);
			$.ajax({
        url: "/recipes/update/" + id,
       	method: "POST",
      	data: {recipe: json},
        timeout: 5500,
        success: function() {
          console.log("success");
				},
      	error: function(jqXHR, textStatus, errorThrown) {
        	console.log("an error has occured");
        	console.log(textStatus);
        	console.log(errorThrown);
        }
			});
		});

  });
</script>


<div class="page-container container">
<!-- pagination -->
<%= will_paginate @recipeList %>

<div class="container">
	<table class = "table table-hover">

		<thead>
			<tr>
				<th>
					<a href="#" id="btnDelete" class="btn btn-warning disabled" >Delete <span class="glyphicon glyphicon-trash"/></a>
				</th>
				<th>
					<a href="#" class="btn btn-success" data-toggle="modal" data-target="#myRecipeModal">Quick Add <span class="glyphicon glyphicon-plus"/></a> 
				</th>
				<th id="chkSelectAll">
					<span class="glyphicon glyphicon-th-list" id="expand_all"/>
					<span> <input type="checkbox" id="check-all" ></span>
				</th>
				<th>
					<div class="input-group">
						<input type="text" class="form-control" placeholder="type in recipe title..."/>
						<span class="input-group-btn">
							<button class="btn btn-default" type="button"> search <span class="glyphicon glyphicon-search"></button>
						</span>
					</div>
				</th>
			</tr>
			<tr>
				<th></th>
				<th>Index</th>
				<th>Select</th>
				<th>Name</th>
			</tr>
		</thead>

		<tbody>

			<% @recipeList.each_with_index do |recipe, index| %>

			<tr>
				<%= add_form_element 'recipe', 'id',
				{ type: 'hidden'},
				{ value: recipe.try(:id) } %>
				<td>
					<span class="glyphicon glyphicon-chevron-down expand" />
				</td>
				<td>
					<%= index %>
				</td>
				<td>
					<span><input type="checkbox" class="check-rec"/>
				</td>
				<td>
					<a class="recTitle" ><%= recipe.title %></a>
				</td>
			</tr>
			<tr class="recipeDetails" style="display: none">
				<td colspan="4" class="detailView">
					<div class="container col-md-12">
						<div class="panel panel-default" id="recipePanel">
							<div class="panel-heading">Recipe Details</div>
							<div class="panel-body">
								<form role="form">
									<%= add_form_element 'recipe', 'id',
										{ type: 'hidden' },
										{ value: recipe.try(:id) } %>
									<div class="form-group">
										<label for="title">Recipe Title</label>
										<textarea class="form-control" id="title" required><%= recipe.title %></textarea>
									</div>
									<div class="form-group">
										<label for="ingredients">Recipe Ingredients:</label>
										<textarea class="form-control"  id="ingredients" required><%= recipe.ingredients %></textarea>
									</div>
									<div class="form-group">
										<label for="directions">Recipe Directions:</label>
										<textarea class="form-control"  id="directions" required><%= recipe.directions %></textarea>
									</div>
									<%= submit_tag('Update', class: "btn btn-warning col-sm-4 col-md-offset-3 update-button") %>
									<%= button_to("Delete", {:action=>:destroy, :id => recipe.id}, :method=>:delete, :class=>"btn btn-danger col-sm-4") %>
								</form>
							</div>
						</div>
					</div>
				</td>
			</tr>
			<% end %>
		</tbody>
	</table>
</div>

<!-- If there is no recipe, tell user -->
<% if @recipeList.empty? %>
	<div class="alert alert-info">No recipes in the database.</div>
<% end %>
<div>
	<%= render 'new_recipe_form' %>	
</div>
