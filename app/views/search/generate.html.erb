<%= javascript_include_tag 'recipe_table.js' %>
<%= javascript_include_tag 'recipe_results.js' %>
<script type="text/javascript">
$(document).ready(function () {
    renderSelectFoods();
    var navListItems = $('div.setup-panel div a'),
        allWells = $('.generate-container');
            
    allWells.hide();
    navListItems.click(function (e) {
        e.preventDefault();
        var $target = $($(this).attr('href')),
            $item = $(this);
        if (!$item.hasClass('disabled')) {
            navListItems.removeClass('btn-primary').addClass('btn-default');
            $item.addClass('btn-primary');
            allWells.hide();
            $target.show();
            $target.find('input:eq(0)').focus();
        }
    });
    $('div.setup-panel div a.btn-primary').trigger('click');
    // Add recipe title to proper position in the preview table.
    $('.add-to').on('click', function (){
      // Get button id.
      var btnId = this.id;
      // Get meal name and option. eg. breakfast option 2.
      var option = btnId.split("-")[1];
      // Get selected recipe name.
      var selected_id = [];
      var selected_recipe_names = [];
      // gather the ids and names of all checked recipes
      $('.check-rec:checked').each(function() {
        var recipe_id = $(this).closest('tr').find('#recipe_id').val();
        var recipe_name = $(this).closest('tr').find('td').find('label').text();
        selected_recipe_names.push(recipe_name);
        selected_id.push(recipe_id);
      });
      
      var i = 0
      $(selected_recipe_names).each(function() {
       var name = selected_recipe_names[i];
       i++;
       var aaa = $('<li/>') // TODO: Does this need to be in a var?
         .text(name)
         .addClass("food-item list-group-item")
         .appendTo("#" + option);
      });
    });
    // If a recipe in the preview meal plan gets clicked.
    
    // handles delete event in recipe preview table.
    $('#btn-delete-preview').on('click', function() {
     var actives = '';
     actives = $('li.highlight-item');
     actives.remove();
    });
     
});
/* Logic for rendering and showing step-1: select foods */
function renderSelectFoods() {
    updateStepLink("step-1");
    $.ajax({
        url: "/search/select_foods/",
        method: "GET",
        dataType: "html",
        timeout: 5000,
        success: function(data) {
            console.log("success");
            $("#step-1").html(data);
            $("#step-1").show();
            $("#step-2").hide();
            $("#step-3").hide();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log("an error has occured");
            console.log(textStatus);
            console.log(errorThrown);
        }
    });
}
/* Logic for rendering and showing step-2: find recipes */
function renderFindRecipes() {
    updateStepLink("step-2");
    // Retrieve each food to have
    var food_items = [];
    $('.have-list').find('li').each(function() {
        food_items.push($(this).text());
    });
    // Send food_items to find_recipes
    console.log(food_items);
    $.ajax({
        url: "/search/find_recipes/",
        method: "POST",
        dataType: "html",
        data: {food_items: JSON.stringify(food_items)},
        timeout: 5000,
        success: function(data) {
            console.log("success");
            $("#step-1").hide();
            $("#step-2").html(data);
            $("#step-2").show();
            $("#step-3").hide();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log("an error has occured");
            console.log(textStatus);
            console.log(errorThrown);
        }
    });
}
/* Logic for rendering and showing step-3: generate meal plan */
function renderGenerateMealPlan() {
    updateStepLink("step-3");
    $.ajax({
        url: "/search/generate_meal_plan/",
        method: "GET",
        dataType: "html",
        timeout: 5000,
        success: function(data) {
            console.log("success");
            $("#step-1").hide();
            $("#step-2").hide();
            $("#step-3").html(data);
            $("#step-3").show();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log("an error has occured");
            console.log(textStatus);
            console.log(errorThrown);
        }
    });
}
/* Ensure the setup wizard links have the proper classes */
function updateStepLink(stepNumber) {
    $('div.setup-panel div a').removeClass('btn-primary').addClass('btn-default');
    $('.stepwizard-step a[href="#' + stepNumber + '"]').addClass('btn-primary');
}
function checkErrors() {
    $(".form-group").removeClass("has-error");
    for(var i = 0; i < curInputs.length; i++) {
        if (!curInputs[i].validity.valid) {
            isValid = false;
            $(curInputs[i]).closest(".form-group").addClass("has-error");
        }
    }
    if (isValid) {
        nextStepWizard.removeAttr('disabled').trigger('click');
    }
}
</script>
<div class="page-container container">
 <div class="stepwizard">
     <div class="stepwizard-row setup-panel">
         <div class="stepwizard-step">
            <%= leap_button '1', {class: 'btn-app step-app', id: 'select-food-next', type: 'button'}, nil, '#step-1' %>
             <p>SELECT FOODS</p>
         </div>
         <div class="stepwizard-step">
            <%= leap_button '2', {class: 'btn-app step-app disabled', id: 'select-food-next', type: 'button'}, nil, '#step-2' %>
             <p>SELECT RECIPES</p>
         </div>
         <div class="stepwizard-step">
            <%= leap_button '3', {class: 'btn-app step-app disabled', id: 'select-food-next', type: 'button'}, nil, '#step-3' %>
             <p>GENERATE</p>
         </div>
     </div>
 </div>
 <form role="form">
    <div class="row generate-container" id="step-1"></div>

    <div class="row generate-container" id="step-2"></div>

    <div class="row generate-container" id="step-3"></div>
 </form>
</div>
<!-- Preview meal plan modal box.-->
<div>
    <%= render 'meal_plan_preview' %> 
</div>